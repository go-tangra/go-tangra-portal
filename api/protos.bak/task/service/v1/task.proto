syntax = "proto3";

package task.service.v1;

import "gnostic/openapi/v3/annotations.proto";

import "google/api/annotations.proto";
import "google/api/field_behavior.proto";

import "google/protobuf/empty.proto";
import "google/protobuf/timestamp.proto";
import "google/protobuf/duration.proto";
import "google/protobuf/field_mask.proto";

import "pagination/v1/pagination.proto";

// Scheduled Task Management Service
service TaskService {
  // Query scheduled task list
  rpc List (pagination.PagingRequest) returns (ListTaskResponse) {}

  // Query scheduled task details
  rpc Get (GetTaskRequest) returns (Task) {}

  // Create scheduled task
  rpc Create (CreateTaskRequest) returns (google.protobuf.Empty) {}

  // Update scheduled task
  rpc Update (UpdateTaskRequest) returns (google.protobuf.Empty) {}

  // Delete scheduled task
  rpc Delete (DeleteTaskRequest) returns (google.protobuf.Empty) {}

  // List task type names
  rpc ListTaskTypeName (google.protobuf.Empty) returns (ListTaskTypeNameResponse) {}

  // Restart all scheduled tasks
  rpc RestartAllTask (google.protobuf.Empty) returns (RestartAllTaskResponse) {}

  // Start all scheduled tasks
  rpc StartAllTask (google.protobuf.Empty) returns (google.protobuf.Empty) {}

  // Stop all scheduled tasks
  rpc StopAllTask (google.protobuf.Empty) returns (google.protobuf.Empty) {}

  // Control scheduled task
  rpc ControlTask (ControlTaskRequest) returns (google.protobuf.Empty) {}
}

// Task Options
message TaskOption {
  optional uint32 max_retry = 1 [
    json_name = "maxRetry",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Maximum number of retry attempts for the task"
    }
  ]; // Maximum number of retry attempts for the task

  optional google.protobuf.Duration timeout = 2 [
    json_name = "timeout",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task timeout duration"
    }
  ]; // Task timeout duration

  optional google.protobuf.Timestamp deadline = 3 [
    json_name = "deadline",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task deadline"
    }
  ]; // Task deadline

  optional google.protobuf.Duration process_in = 4 [
    json_name = "processIn",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task delayed processing time"
    }
  ]; // Task delayed processing time

  optional google.protobuf.Timestamp process_at = 5 [
    json_name = "processAt",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task execution time point"
    }
  ]; // Task execution time point

  optional google.protobuf.Duration unique_ttl = 6 [
    json_name = "uniqueTTL",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task unique lock duration"
    }
  ]; // Task unique lock duration

  optional google.protobuf.Duration retention = 7 [
    json_name = "retention",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task result retention duration"
    }
  ]; // Task result retention duration

  optional string group = 8 [
    json_name = "group",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task group"
    }
  ]; // Task group

  optional string task_id = 9 [
    json_name = "taskID",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task unique identifier ID"
    }
  ]; // Task unique identifier ID
}

// Scheduled Task
message Task {
  // Scheduled Task Type
  enum Type {
    PERIODIC = 0;    // Periodic task
    DELAY = 1;       // Delayed task
    WAIT_RESULT = 2;  // Wait for result
  }

  optional uint32 id = 1 [
    json_name = "id",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task ID"
    }
  ]; // Task ID

  optional Type type = 2 [
    json_name = "type",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task type"
    }
  ]; // Task type

  optional string type_name = 3 [
    json_name = "typeName",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task execution type name, e.g., \"send_email\", \"generate_report\", used to distinguish different types of tasks"
    }
  ]; // Task execution type name

  optional string task_payload = 4 [
    json_name = "taskPayload",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task data, stored in JSON format for convenient storage of different types and amounts of parameters"
    }
  ]; // Task data, stored in JSON format for convenient storage of different types and amounts of parameters

  optional string cron_spec = 5 [
    json_name = "cronSpec",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Cron expression, used to define task scheduling time"
    }
  ]; // Cron expression

  optional TaskOption task_options = 6 [
    json_name = "taskOptions",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task options, stored in JSON format for convenient storage of different types and amounts of options"
    }
  ]; // Task options

  optional bool enable = 10 [
    json_name = "enable",
    (gnostic.openapi.v3.property) = {
      description: "Enable/disable task"
    }
  ]; // Enable/disable task

  optional string remark = 11 [
    json_name = "remark",
    (gnostic.openapi.v3.property) = {description: "Remark"}
  ]; // Remark

  optional uint32 tenant_id = 20 [
    json_name = "tenantId",
    (gnostic.openapi.v3.property) = {description: "Tenant ID, 0 represents system global role"}
  ];  // Tenant ID, 0 represents system global role

  optional uint32 created_by = 100 [json_name = "createdBy", (gnostic.openapi.v3.property) = {description: "Creator ID"}]; // Creator ID
  optional uint32 updated_by = 101 [json_name = "updatedBy", (gnostic.openapi.v3.property) = {description: "Updater ID"}]; // Updater ID
  optional uint32 deleted_by = 102 [json_name = "deletedBy", (gnostic.openapi.v3.property) = {description: "Deleter user ID"}]; // Deleter user ID

  optional google.protobuf.Timestamp created_at = 200 [json_name = "createdAt", (gnostic.openapi.v3.property) = {description: "Created time"}];// Created time
  optional google.protobuf.Timestamp updated_at = 201 [json_name = "updatedAt", (gnostic.openapi.v3.property) = {description: "Updated time"}];// Updated time
  optional google.protobuf.Timestamp deleted_at = 202 [json_name = "deletedAt", (gnostic.openapi.v3.property) = {description: "Deleted time"}];// Deleted time
}

// List Scheduled Tasks - Response
message ListTaskResponse {
  repeated Task items = 1;
  uint64 total = 2;
}

// Get Scheduled Task Details - Request
message GetTaskRequest {
  oneof query_by {
    uint32 id = 1 [
      (gnostic.openapi.v3.property) = {description: "ID", read_only: true},
      json_name = "id"
    ]; // ID

    string type_name = 2 [
      json_name = "typeName",
      (google.api.field_behavior) = OPTIONAL,
      (gnostic.openapi.v3.property) = {
        description: "Task execution type name, e.g., \"send_email\", \"generate_report\", used to distinguish different types of tasks"
      }
    ]; // Task execution type name
  }

  optional google.protobuf.FieldMask view_mask = 100 [
    json_name = "viewMask",
    (gnostic.openapi.v3.property) = {
      description: "View field filter, used to control which fields to return"
    }
  ]; // View field filter, used to control which fields to return
}

// Create Scheduled Task - Request
message CreateTaskRequest {
  Task data = 1;
}

// Update Scheduled Task - Request
message UpdateTaskRequest {
  uint32 id = 1;

  Task data = 2;

  google.protobuf.FieldMask update_mask = 3 [
    (gnostic.openapi.v3.property) = {
      description: "List of fields to update",
      example: {yaml : "id,realname,username"}
    },
    json_name = "updateMask"
  ]; // List of fields to update

  optional bool allow_missing = 4 [
    (gnostic.openapi.v3.property) = {description: "If set to true, the resource will be created (inserted) if it does not exist, and the `updateMask` field will be ignored in this case."},
    json_name = "allowMissing"
  ]; // If set to true, the resource will be created (inserted) if it does not exist, and the `updateMask` field will be ignored in this case.
}

// Delete Scheduled Task - Request
message DeleteTaskRequest {
  uint32 id = 1;
}

// Restart Scheduled Tasks - Response
message RestartAllTaskResponse {
  int32 count = 1;
}

// Control Scheduled Task - Request
message ControlTaskRequest {
  // Scheduled Task Control Type
  enum ControlType {
    Start = 0; // Start
    Stop = 1;  // Stop
    Restart = 2; // Restart
  }

  ControlType control_type = 1 [
    json_name = "controlType",
    (gnostic.openapi.v3.property) = {description: "Control type"}
  ]; // Control type

  string type_name = 2 [
    json_name = "typeName",
    (google.api.field_behavior) = OPTIONAL,
    (gnostic.openapi.v3.property) = {
      description: "Task execution type name, e.g., \"send_email\", \"generate_report\", used to distinguish different types of tasks"
    }
  ]; // Task execution type name
}

// List Task Type Names - Response
message ListTaskTypeNameResponse {
  repeated string type_names = 1 [
    json_name = "typeNames",
    (gnostic.openapi.v3.property) = {description: "List of type names"}
  ]; // List of type names
}
