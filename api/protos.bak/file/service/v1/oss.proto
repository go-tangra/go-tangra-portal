syntax = "proto3";

package file.service.v1;

import "gnostic/openapi/v3/annotations.proto";
import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";

// OSS Service
service OssService {
  // Get Object Storage (OSS) upload URL
  rpc GetUploadPresignedUrl (GetUploadPresignedUrlRequest) returns (GetUploadPresignedUrlResponse) {}

  // Get Object Storage (OSS) download URL
  rpc GetDownloadUrl (GetDownloadInfoRequest) returns (GetDownloadInfoResponse) {}

  // Get file list in a folder
  rpc ListOssFile (ListOssFileRequest) returns (ListOssFileResponse) {}

  // Delete a file
  rpc DeleteOssFile (DeleteOssFileRequest) returns (DeleteOssFileResponse) {}
}

// Storage Object
message StorageObject {
  optional string bucket_name = 1 [
    json_name = "bucketName",
    (gnostic.openapi.v3.property) = { description: "Target bucket name" }
  ];

  optional string file_directory = 2 [
    json_name = "fileDirectory",
    (gnostic.openapi.v3.property) = {
      description: "Storage directory (e.g., 'user/1001/avatar/'), server will generate unique file name in this directory",
      example: {yaml : "tenant/1001/user/avatar/"}
    }
  ];

  optional string object_name = 3 [
    json_name = "objectName",
    (gnostic.openapi.v3.property) = {
      description: "OSS object key (full path, e.g., 'user/1001/avatar.jpg'). If not provided, server will auto-generate.",
      example: {yaml : "user/1001/avatar.jpg"}
    }
  ]; // OSS object key (full path, e.g., 'user/1001/avatar.jpg'). If not provided, server will auto-generate.
}

// Presign Option
message PresignOption {
  optional string method = 1 [
    json_name = "method",
    (gnostic.openapi.v3.property) = { description: "HTTP method for presigning, e.g., PUT or POST" }
  ];

  optional int32 expire_seconds = 2 [
    json_name = "expireSeconds",
    (gnostic.openapi.v3.property) = { description: "Presign validity period in seconds" }
  ];

  optional string content_type = 3 [
    json_name = "contentType",
    (gnostic.openapi.v3.property) = { description: "Content-Type constraint for presign (optional)" }
  ];
}

// Get Object Storage Upload URL - Request
message GetUploadPresignedUrlRequest {
  // HTTP method for frontend file upload
  enum Method {
    Put = 0;
    Post = 1;
  }

  Method method = 1 [
    json_name = "method",
    (gnostic.openapi.v3.property) = { description: "HTTP method for file upload, supports POST and PUT" }
  ];  // HTTP method for file upload

  optional string content_type = 2 [
    json_name = "contentType",
    (gnostic.openapi.v3.property) = { description: "MIME type of the file" }
  ];  // MIME type of the file

  optional string bucket_name = 3 [
    json_name = "bucketName",
    (gnostic.openapi.v3.property) = { description: "Bucket name, if not provided, will be auto-resolved based on file name or MIME type" }
  ]; // Bucket name, if not provided, will be auto-resolved based on file name or MIME type.

  optional string file_directory = 4 [
    json_name = "fileDirectory",
    (gnostic.openapi.v3.property) = { description: "Remote file path, optional" }
  ]; // Remote file path, optional.

  optional string file_name = 5 [
    json_name = "fileName",
    (gnostic.openapi.v3.property) = { description: "File name, if not provided, UUID will be generated; duplicate names will also be replaced with UUID" }
  ]; // File name, if not provided, UUID will be generated; duplicate names will also be replaced with UUID.

  optional int32 expire_seconds = 6 [
    json_name = "expireSeconds",
    (gnostic.openapi.v3.property) = { description: "Presign validity period in seconds" }
  ];
}

// Get Object Storage Upload URL - Response
message GetUploadPresignedUrlResponse {
  string upload_url = 1 [
    json_name = "uploadUrl",
    (gnostic.openapi.v3.property) = { description: "File upload URL, default expiration time is 1 hour" }
  ]; // File upload URL, default expiration time is 1 hour.

  string download_url = 2 [
    json_name = "downloadUrl",
    (gnostic.openapi.v3.property) = { description: "File download URL" }
  ]; // File download URL

  optional string bucket_name = 3 [
    json_name = "bucketName",
    (gnostic.openapi.v3.property) = { description: "Bucket name" }
  ]; // Bucket name

  string object_name = 4 [
    json_name = "objectName",
    (gnostic.openapi.v3.property) = { description: "OSS object key" }
  ];  // OSS object key

  map<string, string> form_data = 5 [
    json_name = "formData",
    (gnostic.openapi.v3.property) = { description: "Form data, used when POST method is selected" }
  ];
}

message GetDownloadInfoRequest {
  oneof selector {
    uint64 file_id = 1 [
      json_name = "fileId",
      (gnostic.openapi.v3.property) = { description: "Server internal file ID" }
    ]; // Server internal file ID

    StorageObject storage_object = 2 [
      json_name = "storageObject",
      (gnostic.openapi.v3.property) = { description: "bucket + object location" }
    ]; // bucket + object location

    string download_url = 3 [
      json_name = "downloadUrl",
      (gnostic.openapi.v3.property) = { description: "Direct external URL (can be used for proxy or validation)" }
    ]; // Direct external URL (can be used for proxy or validation)
  }

  // Optional partial download range (closed interval start, open interval end; 0/0 means full content)
  optional int64 range_start = 4 [
    json_name = "rangeStart",
    (gnostic.openapi.v3.property) = { description: "Download range start, closed interval" }
  ]; // Download range start, closed interval
  optional int64 range_end = 5 [
    json_name = "rangeEnd",
    (gnostic.openapi.v3.property) = { description: "Download range end, open interval" }
  ]; // Download range end, open interval

  optional bool prefer_presigned_url = 6 [
    json_name = "preferPresignedUrl",
    (gnostic.openapi.v3.property) = { description: "Prefer returning presigned URL instead of direct bytes (when available)" }
  ]; // Prefer returning presigned URL instead of direct bytes (when available)

  optional int32 presign_expire_seconds = 7 [
    json_name = "presignExpireSeconds",
    (gnostic.openapi.v3.property) = { description: "Presigned URL validity period in seconds, only meaningful when prefer_presigned_url is true" }
  ]; // Presigned URL validity period in seconds, only meaningful when prefer_presigned_url is true

  optional string disposition = 8 [
    json_name = "disposition",
    (gnostic.openapi.v3.property) = { description: "Client expected Content-Disposition value, commonly attachment or inline" }
  ]; // Client expected Content-Disposition value, commonly "attachment" or "inline"

  // Client expected MIME type (can be used for backend selection or conversion)
  optional string accept_mime = 9 [
    json_name = "acceptMime",
    (gnostic.openapi.v3.property) = { description: "Client expected MIME type (can be used for backend selection or conversion)" }
  ]; // Client expected MIME type (can be used for backend selection or conversion)
}

message GetDownloadInfoResponse {
  // Transfer content (one of two)
  oneof content {
    bytes file = 1 [
      json_name = "file",
      (gnostic.openapi.v3.property) = { description: "Direct file bytes (for small files or synchronous scenarios)" }
    ]; // Direct file bytes (for small files or synchronous scenarios)

    string download_url = 2 [
      json_name = "downloadUrl",
      (gnostic.openapi.v3.property) = { description: "Presigned URL (for large files or async download)" }
    ]; // Presigned URL (for large files or async download)
  }

  string source_file_name = 3 [
    json_name = "sourceFileName",
    (gnostic.openapi.v3.property) = { description: "Original file name, for client to save or display" }
  ]; // Original file name, for client to save or display

  string mime = 4 [
    json_name = "mime",
    (gnostic.openapi.v3.property) = { description: "MIME type, default application/octet-stream" }
  ]; // MIME type, default application/octet-stream

  int64 size = 5 [
    json_name = "size",
    (gnostic.openapi.v3.property) = { description: "File size in bytes, can be used for progress or verification" }
  ]; // File size in bytes, can be used for progress or verification

  string checksum = 6 [
    json_name = "checksum",
    (gnostic.openapi.v3.property) = { description: "Optional, file checksum (e.g., MD5 or SHA256)" }
  ]; // Optional, file checksum (e.g., MD5 or SHA256)

  string storage_path = 7 [
    json_name = "storagePath",
    (gnostic.openapi.v3.property) = { description: "Optional, backend storage location or key" }
  ]; // Optional, backend storage location or key

  optional google.protobuf.Timestamp updated_at = 8 [
    json_name = "updatedAt",
    (gnostic.openapi.v3.property) = { description: "Optional, last modified time" }
  ]; // Optional, last modified time

  map<string, string> headers = 9 [
    json_name = "headers",
    (gnostic.openapi.v3.property) = { description: "When returning presigned URL, may require additional request headers (or form fields)" }
  ]; // When returning presigned URL, may require additional request headers (or form fields)

  optional string method = 10 [
    json_name = "method",
    (gnostic.openapi.v3.property) = { description: "Suggested request method (e.g., GET / HEAD), can be specified when returning presigned URL" }
  ]; // Suggested request method (e.g., GET / HEAD), can be specified when returning presigned URL
}

message ListOssFileRequest {
  optional string bucket_name = 1 [
    json_name = "bucketName",
    (gnostic.openapi.v3.property) = { description: "Bucket name" }
  ]; // Bucket name

  optional string folder = 2 [
    json_name = "folder",
    (gnostic.openapi.v3.property) = { description: "Folder name" }
  ]; // Folder name

  optional bool recursive = 3 [
    json_name = "recursive",
    (gnostic.openapi.v3.property) = { description: "Whether to recursively list folder contents" }
  ]; // Whether to recursively list folder contents
}

message ListOssFileResponse {
  repeated string files = 1 [
    json_name = "files",
    (gnostic.openapi.v3.property) = { description: "File list" }
  ];
}

message DeleteOssFileRequest {
  optional string bucket_name = 1 [
    json_name = "bucketName",
    (gnostic.openapi.v3.property) = { description: "Bucket name" }
  ]; // Bucket name

  optional string object_name = 2 [
    json_name = "objectName",
    (gnostic.openapi.v3.property) = { description: "OSS object key" }
  ]; // OSS object key
}

message DeleteOssFileResponse {

}
