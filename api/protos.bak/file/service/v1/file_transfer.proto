syntax = "proto3";

package file.service.v1;

import "gnostic/openapi/v3/annotations.proto";
import "google/api/httpbody.proto";
import "google/protobuf/timestamp.proto";

import "file/service/v1/oss.proto";

// File Transfer Service
service FileTransferService {
  // Download file
  rpc DownloadFile (DownloadFileRequest) returns (stream google.api.HttpBody) {}

  // Upload file via PUT method
  rpc PutUploadFile (stream google.api.HttpBody) returns (UploadFileResponse) {}

  // Upload file via POST method
  rpc PostUploadFile (stream google.api.HttpBody) returns (UploadFileResponse) {}
}

// File Download Request
message DownloadFileRequest {
  oneof selector {
    uint32 file_id = 1 [
      json_name = "fileId",
      (gnostic.openapi.v3.property) = { description: "Server internal file ID" }
    ]; // Server internal file ID

    StorageObject storage_object = 2 [
      json_name = "storageObject",
      (gnostic.openapi.v3.property) = { description: "Object storage object" }
    ]; // Object storage object

    string download_url = 3 [
      json_name = "downloadUrl",
      (gnostic.openapi.v3.property) = { description: "Direct external URL (can be used for proxy or validation)" }
    ]; // Direct external URL (can be used for proxy or validation)
  }

  // Optional partial download range (closed interval start, open interval end; 0/0 means full content)
  optional int64 range_start = 4 [
    json_name = "rangeStart",
    (gnostic.openapi.v3.property) = { description: "Download range start, closed interval" }
  ]; // Download range start, closed interval
  optional int64 range_end = 5 [
    json_name = "rangeEnd",
    (gnostic.openapi.v3.property) = { description: "Download range end, open interval" }
  ]; // Download range end, open interval

  optional bool prefer_presigned_url = 6 [
    json_name = "preferPresignedUrl",
    (gnostic.openapi.v3.property) = { description: "Prefer returning presigned URL instead of direct bytes (when available)" }
  ]; // Prefer returning presigned URL instead of direct bytes (when available)

  optional int32 presign_expire_seconds = 7 [
    json_name = "presignExpireSeconds",
    (gnostic.openapi.v3.property) = { description: "Presigned URL validity period in seconds, only meaningful when prefer_presigned_url is true" }
  ]; // Presigned URL validity period in seconds, only meaningful when prefer_presigned_url is true

  optional string disposition = 8 [
    json_name = "disposition",
    (gnostic.openapi.v3.property) = { description: "Client expected Content-Disposition value, commonly attachment or inline (default attachment)" }
  ]; // Client expected Content-Disposition value, commonly "attachment" or "inline" (default attachment)

  optional string accept_mime = 9 [
    json_name = "acceptMime",
    (gnostic.openapi.v3.property) = { description: "Client expected MIME type (can be used for backend selection or conversion)" }
  ]; // Client expected MIME type (can be used for backend selection or conversion)
}

// File Download Response
message DownloadFileResponse {
  // Transfer content (one of two)
  oneof content {
    bytes file = 1 [
      json_name = "file",
      (gnostic.openapi.v3.property) = { description: "Direct file bytes (for small files or synchronous scenarios)" }
    ]; // Direct file bytes (for small files or synchronous scenarios)

    string download_url = 2 [
      json_name = "downloadUrl",
      (gnostic.openapi.v3.property) = { description: "Presigned URL (for large files or async download)" }
    ]; // Presigned URL (for large files or async download)
  }

  string source_file_name = 3 [
    json_name = "sourceFileName",
    (gnostic.openapi.v3.property) = { description: "Original file name, for client to save or display" }
  ]; // Original file name, for client to save or display

  string mime = 4 [
    json_name = "mime",
    (gnostic.openapi.v3.property) = { description: "MIME type, default application/octet-stream" }
  ]; // MIME type, default application/octet-stream

  int64 size = 5 [
    json_name = "size",
    (gnostic.openapi.v3.property) = { description: "File size in bytes, can be used for progress or verification" }
  ]; // File size in bytes, can be used for progress or verification

  string checksum = 6 [
    json_name = "checksum",
    (gnostic.openapi.v3.property) = { description: "Optional, file checksum (e.g., MD5 or SHA256)" }
  ]; // Optional, file checksum (e.g., MD5 or SHA256)

  string storage_path = 7 [
    json_name = "storagePath",
    (gnostic.openapi.v3.property) = { description: "Optional, backend storage location or key" }
  ]; // Optional, backend storage location or key

  optional google.protobuf.Timestamp updated_at = 8 [
    json_name = "updatedAt",
    (gnostic.openapi.v3.property) = { description: "Optional, last modified time" }
  ]; // Optional, last modified time
}

message UploadFileRequest {
  StorageObject storage_object = 1 [
    json_name = "storageObject",
    (gnostic.openapi.v3.property) = { description: "Object storage object" }
  ]; // Object storage object

  oneof source {
    bytes file = 2 [
      json_name = "file",
      (gnostic.openapi.v3.property) = { description: "Direct upload file content (inline bytes)" }
    ];

    PresignOption presign = 3 [
      json_name = "presign",
      (gnostic.openapi.v3.property) = { description: "Request service to return presigned info (get presigned URL instead of uploading file)" }
    ];
  }

  optional string source_file_name = 4 [
    json_name = "sourceFileName",
    (gnostic.openapi.v3.property) = { description: "Original file name" }
  ]; // Original file name

  optional string mime = 5 [
    json_name = "mime",
    (gnostic.openapi.v3.property) = { description: "MIME type of the file" }
  ]; // MIME type of the file

  optional int64 size = 6 [
    json_name = "size",
    (gnostic.openapi.v3.property) = { description: "File size in bytes" }
  ]; // File size in bytes
}

message UploadFileResponse {
  optional string object_name = 1 [
    json_name = "objectName",
    (gnostic.openapi.v3.property) = { description: "OSS object key" }
  ]; // OSS object key

  optional string presigned_url = 2 [
    json_name = "presignedUrl",
    (gnostic.openapi.v3.property) = { description: "Presigned upload URL" }
  ]; // Presigned upload URL
}
